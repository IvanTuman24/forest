<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–ê–ó–ê 10.5 - –°–í–Ø–ó–¨ –£–°–¢–ê–ù–û–í–õ–ï–ù–ê</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --accent: #ff9d00; --bg: #0e120a; --panel: #1a1d16; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; color: #e0e0e0; }
        
        #mode-selector { 
            position: fixed; inset: 0; z-index: 10000; 
            background: #0e120a; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; gap: 25px; 
        }
        .mode-btn { 
            padding: 25px 50px; font-size: 22px; font-weight: bold; 
            border-radius: 15px; border: none; cursor: pointer; width: 320px;
        }

        #main-container { display: flex; width: 100vw; height: 100vh; }
        #forest { flex: 1; position: relative; overflow: hidden; background: #000; }
        #bg-media-container { position: absolute; width: 100%; height: 100%; z-index: 1; display: flex; align-items: center; justify-content: center; transform-origin: bottom center; }
        #bg-img, #bg-video { width: 100%; height: 100%; object-fit: contain; transition: transform 0.2s; }

        #hero-layer { position: absolute; inset: 0; z-index: 2; pointer-events: none; }

        #scanner { width: 100%; max-width: 350px; background: var(--panel); display: flex; flex-direction: column; padding: 15px; z-index: 10; overflow-y: auto; border-left: 2px solid #2d3326; }
        .hidden { display: none !important; }
        .group { background: #22261d; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; }
        button { width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; background: #3d4435; color: white; margin-top: 8px; }
        input[type="range"] { width: 100%; accent-color: var(--accent); margin: 10px 0; }
        .hero { position: absolute; will-change: transform; }
        .journal-item { background: #151812; padding: 10px; border-radius: 8px; margin-top: 8px; border: 1px solid #444; }
    </style>
</head>
<body>

<div id="mode-selector">
    <h1 style="color:var(--accent); margin-bottom:10px;">–ë–ê–ó–ê 10.5</h1>
    <button id="btn-screen" class="mode-btn" style="background:#3d4435; color:white;">üíª –≠–ö–†–ê–ù (–ü–†–û–ï–ö–¢–û–†)</button>
    <button id="btn-remote" class="mode-btn" style="background:var(--accent); color:black;">üì± –ü–£–õ–¨–¢ (–¢–ï–õ–ï–§–û–ù)</button>
</div>

<div id="main-container">
    <div id="forest">
        <div id="bg-media-container">
            <img id="bg-img" src="https://images.unsplash.com/photo-1511497584788-876760111969?auto=format&fit=crop&w=1500&q=80">
            <video id="bg-video" loop muted playsinline style="display:none;"></video>
        </div>
        <div id="hero-layer"></div>
    </div>

    <div id="scanner" class="hidden">
        <div class="group">
            <div style="font-size:12px; color:var(--accent); font-weight:bold;">–°–ï–¢–¨: <span id="db-status">–ü–†–û–í–ï–†–ö–ê...</span></div>
            <button onclick="$('bg-in').click()">üñºÔ∏è –°–ú–ï–ù–ò–¢–¨ –§–û–ù</button>
            <input type="file" id="bg-in" hidden accept="image/*,video/*">
            <label style="font-size:11px; display:block; margin-top:15px;">–ú–ê–°–®–¢–ê–ë:</label>
            <input type="range" id="zoom-ctrl" min="50" max="250" value="100">
        </div>
        <div class="group">
            <input type="password" id="api-key" placeholder="API Key (remove.bg)" style="width:100%; padding:12px; background:#111; border:1px solid #444; color:#fff; margin-bottom:10px;">
            <button id="scan-btn" style="background:var(--accent); color:black;">üì∏ –°–ö–ê–ù–ï–† –ì–ï–†–û–ï–í</button>
        </div>
        <div id="hero-journal"></div>
    </div>
</div>

<script>
    const $ = id => document.getElementById(id);

    // –¢–í–û–Ø –ü–†–Ø–ú–ê–Ø –°–°–´–õ–ö–ê –ù–ê –ë–ê–ó–£
    const firebaseConfig = {
        apiKey: "AIzaSyAOdgn7U8MKRbroByVJJXyL2NgQS405M64",
        authDomain: "lesbaza-d8fc9.firebaseapp.com",
        projectId: "lesbaza-d8fc9",
        databaseURL: "https://lesbaza-d8fc9-default-rtdb.europe-west1.firebasedatabase.app/"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const dbRef = database.ref('forest_session');

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    database.ref('.info/connected').on('value', snap => {
        const s = $('db-status');
        if(s) s.innerText = snap.val() ? "–û–ö ‚úÖ" : "–û–®–ò–ë–ö–ê ‚ùå";
    });

    const state = { heroes: [], isRemote: false };

    // –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞
    $('btn-screen').addEventListener('click', () => {
        $('mode-selector').style.display = 'none';
        $('scanner').classList.add('hidden');
        initApp(false);
    });

    $('btn-remote').addEventListener('click', () => {
        $('mode-selector').style.display = 'none';
        $('scanner').classList.remove('hidden');
        $('forest').classList.add('hidden');
        initApp(true);
    });

    function initApp(isRemote) {
        state.isRemote = isRemote;
        
        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        dbRef.on('value', snap => {
            const data = snap.val() || {};
            if (data.world) applyWorld(data.world);
            if (data.heroes) applyHeroes(data.heroes);
        });

        if (isRemote) {
            $('zoom-ctrl').oninput = (e) => {
                dbRef.child('world').update({ zoom: parseInt(e.target.value) });
            };
        }

        requestAnimationFrame(updatePhysics);
    }

    function applyWorld(w) {
        if (w.zoom) {
            const s = w.zoom / 100;
            $('bg-img').style.transform = `scale(${s})`;
            $('bg-video').style.transform = `scale(${s})`;
        }
        if (w.bgSrc && !state.isRemote) {
            if ($('bg-img').src !== w.bgSrc) $('bg-img').src = w.bgSrc;
        }
    }

    function applyHeroes(cloudHeroes) {
        // –£–¥–∞–ª–µ–Ω–∏–µ
        state.heroes.forEach(h => {
            if (!cloudHeroes[h.id]) { h.el.remove(); h.deleted = true; }
        });
        state.heroes = state.heroes.filter(h => !h.deleted);

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ/–°–æ–∑–¥–∞–Ω–∏–µ
        Object.keys(cloudHeroes).forEach(id => {
            const d = cloudHeroes[id];
            let h = state.heroes.find(x => x.id == id);
            if (!h) {
                const img = document.createElement('img');
                img.src = d.src; img.className = 'hero';
                $('hero-layer').appendChild(img);
                h = { id, el: img };
                state.heroes.push(h);
                if (state.isRemote) createJournalItem(id);
            }
            h.x = d.x; h.y = d.y; h.size = d.size; h.speed = d.speed; h.dx = d.dx;
            h.el.style.width = h.size + 'px';
        });
    }

    function createJournalItem(id) {
        if ($('item-'+id)) return;
        const div = document.createElement('div');
        div.className = 'journal-item'; div.id = 'item-'+id;
        div.innerHTML = `<span>–ì–µ—Ä–æ–π ${id.toString().slice(-4)}</span>
            <button onclick="firebase.database().ref('forest_session/heroes/${id}').remove()" style="background:#622; float:right; width:40px;">‚úñ</button>`;
        $('hero-journal').appendChild(div);
    }

    function updatePhysics() {
        if (!state.isRemote) {
            const viewW = $('forest').clientWidth;
            state.heroes.forEach(h => {
                h.x += (h.speed / 10) * h.dx;
                if (h.x > viewW) h.x = -h.size;
                if (h.x < -h.size) h.x = viewW;
                h.el.style.transform = `translate(${h.x}px, ${h.y}px) scaleX(${h.dx > 0 ? -1 : 1})`;
            });
        }
        requestAnimationFrame(updatePhysics);
    }
</script>
</body>
</html>
