<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–õ–ï–° 18.0 - –ì–ò–ë–†–ò–î–ù–ê–Ø –ë–ê–ó–ê</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --accent: #00ffcc; --panel: #111411; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: #eee; }

        /* –í–´–ë–û–† –†–ï–ñ–ò–ú–ê */
        #mode-selector { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
        .mode-btn { width: 300px; padding: 30px; border-radius: 15px; border: 2px solid var(--accent); background: #111; color: white; cursor: pointer; text-align: center; transition: 0.3s; }
        .mode-btn:hover { background: var(--accent); color: #000; }

        #main-wrapper { display: flex; width: 100vw; height: 100vh; position: relative; }

        /* –õ–ï–° */
        #forest { flex: 1; position: relative; overflow: hidden; background: #000; }
        #bg-container { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; transform-origin: center center; }
        #bg-media { min-width: 100%; min-height: 100%; object-fit: cover; }
        #hero-layer { position: absolute; inset: 0; z-index: 5; pointer-events: none; }

        @keyframes wind { 0%, 100% { transform: skewX(0deg); } 50% { transform: skewX(var(--w-p, 2deg)); } }
        .wind-active { animation: wind var(--w-s, 5s) ease-in-out infinite; }

        .hero { position: absolute; will-change: transform; transform-origin: center bottom; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5)); }

        /* –ü–ê–ù–ï–õ–¨ */
        #side-panel { width: 340px; background: var(--panel); border-left: 1px solid #333; display: flex; flex-direction: column; transition: 0.4s; z-index: 100; position: relative; }
        #side-panel.hidden { margin-right: -340px; }
        #toggle-panel { position: absolute; left: -45px; top: 20px; width: 45px; height: 45px; background: var(--panel); border: 1px solid #333; border-right: none; color: var(--accent); cursor: pointer; border-radius: 10px 0 0 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        .content { padding: 15px; overflow-y: auto; flex: 1; }
        .group { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #333; }
        .group-title { font-size: 10px; text-transform: uppercase; color: var(--accent); margin-bottom: 8px; font-weight: bold; letter-spacing: 1px; }

        /* –°–ö–ê–ù–ï–† */
        #cam-box { width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 8px; overflow: hidden; position: relative; border: 1px solid #444; }
        video#feed { width: 100%; height: 100%; object-fit: cover; }
        canvas#scanner-preview { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; opacity: 0.5; }

        #ai-status { padding: 8px; border-radius: 6px; font-size: 11px; text-align: center; margin-bottom: 10px; font-weight: bold; border: 1px solid #333; }
        .status-ok { background: rgba(0,255,204,0.1); color: var(--accent); border-color: var(--accent); }

        button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: #2a2d26; color: white; font-size: 11px; margin-top: 5px; transition: 0.2s; }
        .btn-ai { background: var(--accent) !important; color: #000 !important; }
        button:active { transform: scale(0.98); }

        input[type="range"] { width: 100%; accent-color: var(--accent); margin: 5px 0; }
        input[type="password"] { width: 100%; padding: 10px; background: #000; border: 1px solid #333; color: white; border-radius: 6px; margin-bottom: 8px; }

        /* –°–ü–ò–°–û–ö –ì–ï–†–û–ï–í */
        .h-item { display: flex; align-items: center; gap: 10px; background: #000; padding: 8px; border-radius: 8px; margin-top: 8px; border: 1px solid #333; }
        .h-mini { width: 40px; height: 40px; object-fit: contain; background: #111; border-radius: 4px; }

        #qr-box { position: absolute; top: 20px; left: 20px; background: white; padding: 10px; border-radius: 10px; z-index: 1000; display: none; text-align: center; color: black; }
    </style>
</head>
<body>

<div id="mode-selector">
    <div class="mode-btn" onclick="start('screen')"><h2>üñ•Ô∏è –≠–ö–†–ê–ù</h2><p>–û—Å–Ω–æ–≤–Ω–æ–π –ª–µ—Å</p></div>
    <div class="mode-btn" onclick="start('device')"><h2>üì± –¢–ï–õ–ï–§–û–ù</h2><p>–ü—É–ª—å—Ç –∑–∞–≥—Ä—É–∑–∫–∏</p></div>
</div>

<div id="main-wrapper">
    <div id="forest">
        <div id="qr-box">
            <div id="qr-img"></div>
            <p style="font-size: 10px; font-weight: bold; margin-top: 5px;">–ü–£–õ–¨–¢ –£–ü–†–ê–í–õ–ï–ù–ò–Ø</p>
        </div>
        <div id="bg-container" class="wind-active">
            <img id="bg-media" src="https://images.unsplash.com/photo-1511497584788-876760111969?q=80&w=1920">
        </div>
        <div id="hero-layer"></div>
    </div>

    <div id="side-panel">
        <div id="toggle-panel" onclick="$('side-panel').classList.toggle('hidden')">‚ò∞</div>
        <div class="content">
            <div id="ai-status" class="status-ok">–°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê</div>

            <div class="group">
                <div class="group-title">1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ò–ò</div>
                <input type="password" id="api-key" placeholder="Remove.bg API Key">
                <div id="cam-box">
                    <video id="feed" autoplay playsinline></video>
                    <canvas id="scanner-preview"></canvas>
                </div>
                <button class="btn-ai" onclick="processFromCam()">‚úÇÔ∏è –í–´–†–ï–ó–ê–¢–¨ –° –ö–ê–ú–ï–†–´</button>
                <button onclick="$('hero-pc').click()">üìÇ –ó–ê–ì–†–£–ó–ò–¢–¨ –° –ü–ö</button>
                <input type="file" id="hero-pc" hidden onchange="processFromFile(this)">
            </div>

            <div class="group">
                <div class="group-title">2. –°—Ä–µ–¥–∞ –∏ –ó–≤—É–∫</div>
                <button onclick="$('bg-in').click()">üñºÔ∏è –°–ú–ï–ù–ò–¢–¨ –õ–ï–°</button>
                <input type="file" id="bg-in" hidden onchange="changeBg(this)">
                
                <label style="font-size:9px">–í–ï–¢–ï–†</label>
                <input type="range" min="1" max="20" value="10" oninput="setWind(this.value)">
                
                <label style="font-size:9px">–ó–í–£–ö</label>
                <button onclick="$('audio-in').click()">üéµ –î–û–ë–ê–í–ò–¢–¨ –ó–í–£–ö</button>
                <input type="file" id="audio-in" hidden accept="audio/*" onchange="loadAudio(this)">
                <input type="range" id="vol" min="0" max="1" step="0.1" value="0.5" oninput="if(window.bgAudio) window.bgAudio.volume=this.value">
            </div>

            <div class="group">
                <button style="background:#572e8b" onclick="toggleQR()">üì≤ –¢–ï–õ–ï–§–û–ù-–ü–£–õ–¨–¢</button>
            </div>

            <div id="journal"></div>
        </div>
    </div>
</div>

<script>
    const $ = id => document.getElementById(id);
    let heroes = [];
    let peer, conn;
    let role = '';

    // --- –°–¢–ê–†–¢ ---
    async function start(m) {
        role = m;
        $('mode-selector').style.display = 'none';
        if(role === 'device') {
            $('forest').style.display = 'none';
            $('side-panel').style.width = '100%';
            $('side-panel').classList.remove('hidden');
            $('toggle-panel').style.display = 'none';
            initPeer(null);
        } else {
            initPeer('forest-base-123');
            initCamera();
        }
        requestAnimationFrame(animate);
    }

    async function initCamera() {
        try {
            const s = await navigator.mediaDevices.getUserMedia({video: {facingMode: "environment"}});
            $('feed').srcObject = s;
        } catch(e) { setStatus("–ö–ê–ú–ï–†–ê –ù–ï–î–û–°–¢–£–ü–ù–ê", "err"); }
    }

    // --- –°–í–Ø–ó–¨ ---
    function initPeer(id) {
        peer = new Peer(id);
        peer.on('open', (myId) => {
            if(role === 'device') {
                const params = new URLSearchParams(window.location.search);
                connectTo(params.get('c') || 'forest-base-123');
            }
        });
        peer.on('connection', c => {
            conn = c;
            setStatus("üì± –ü–£–õ–¨–¢ –ü–û–î–ö–õ–Æ–ß–ï–ù");
            conn.on('data', data => { if(data.type==='hero') addHero(data.src); });
        });
    }

    function connectTo(tid) {
        conn = peer.connect(tid);
        conn.on('open', () => setStatus("‚úÖ –°–í–Ø–ó–¨ –° –≠–ö–†–ê–ù–û–ú"));
    }

    function toggleQR() {
        const url = window.location.href.split('?')[0] + '?c=forest-base-123';
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}`;
        $('qr-img').innerHTML = `<img src="${qrUrl}">`;
        $('qr-box').style.display = $('qr-box').style.display === 'block' ? 'none' : 'block';
    }

    // --- –û–ë–†–ê–ë–û–¢–ö–ê –ò–ò ---
    async function callAI(blob) {
        const key = $('api-key').value;
        if(!key) { alert("–í–≤–µ–¥–∏—Ç–µ API –ö–õ–Æ–ß!"); return; }
        setStatus("üöÄ –ò–ò –í–´–†–ï–ó–ê–ï–¢...");
        
        const fd = new FormData();
        fd.append('image_file', blob);

        try {
            const res = await fetch('https://api.remove.bg/v1.0/removebg', {
                method: 'POST', headers: {'X-Api-Key': key}, body: fd
            });
            if(res.ok) {
                const b = await res.blob();
                if(role === 'device' && conn) {
                    const reader = new FileReader();
                    reader.onloadend = () => conn.send({type: 'hero', src: reader.result});
                    reader.readAsDataURL(b);
                    setStatus("‚ú® –û–¢–ü–†–ê–í–õ–ï–ù–û!");
                } else {
                    addHero(URL.createObjectURL(b));
                    setStatus("‚ú® –ì–û–¢–û–í–û!");
                }
            } else { setStatus("‚ùå –û–®–ò–ë–ö–ê –ò–ò"); }
        } catch(e) { setStatus("‚ùå –û–®–ò–ë–ö–ê –°–ï–¢–ò"); }
    }

    function processFromCam() {
        const c = document.createElement('canvas');
        const v = $('feed');
        c.width = v.videoWidth; c.height = v.videoHeight;
        c.getContext('2d').drawImage(v, 0, 0);
        c.toBlob(blob => callAI(blob));
    }

    function processFromFile(i) {
        if(i.files[0]) callAI(i.files[0]);
    }

    // --- –ú–ï–•–ê–ù–ò–ö–ê –õ–ï–°–ê ---
    function addHero(src) {
        const id = Date.now();
        const img = document.createElement('img');
        img.src = src; img.className = 'hero';
        
        const line = heroes.length % 2;
        const forestH = $('forest').clientHeight;
        const ground = line === 0 ? forestH * 0.5 : forestH * 0.9;
        const size = line === 0 ? 150 : 250;

        img.style.bottom = (forestH - ground) + "px";
        img.style.zIndex = line === 0 ? "4" : "10";
        img.style.width = size + "px";
        $('hero-layer').appendChild(img);

        const hObj = { id, el: img, x: -200, y: ground, size, speed: 5 + Math.random()*5, angle: 0 };
        heroes.push(hObj);

        const item = document.createElement('div');
        item.className = 'h-item'; item.id = 'ui-'+id;
        item.innerHTML = `
            <img src="${src}" class="h-mini">
            <input type="range" min="50" max="600" value="${size}" oninput="updateHero(${id}, 's', this.value)">
            <button onclick="delHero(${id})" style="width:30px; background:#632c2c">√ó</button>
        `;
        $('journal').appendChild(item);
    }

    function updateHero(id, type, val) {
        const h = heroes.find(x => x.id === id);
        if(h && type === 's') { h.size = val; h.el.style.width = val + "px"; }
    }

    function delHero(id) {
        const i = heroes.findIndex(x => x.id === id);
        if(i > -1) { heroes[i].el.remove(); heroes.splice(i, 1); $('ui-'+id).remove(); }
    }

    function setWind(v) {
        document.documentElement.style.setProperty('--w-s', (21 - v) / 2 + 's');
        document.documentElement.style.setProperty('--w-p', (v / 2) + 'deg');
    }

    function loadAudio(i) {
        if(window.bgAudio) window.bgAudio.pause();
        window.bgAudio = new Audio(URL.createObjectURL(i.files[0]));
        window.bgAudio.loop = true;
        window.bgAudio.volume = $('vol').value;
        window.bgAudio.play();
    }

    function changeBg(i) {
        if(i.files[0]) $('bg-media').src = URL.createObjectURL(i.files[0]);
    }

    function setStatus(t, s) {
        $('ai-status').innerText = t;
        $('ai-status').className = s === 'err' ? '' : 'status-ok';
    }

    function animate() {
        const w = $('forest').clientWidth;
        heroes.forEach(h => {
            h.x += h.speed / 10;
            if(h.x > w + 200) h.x = -h.size;
            h.angle += 0.05;
            h.el.style.transform = `translateX(${h.x}px) translateY(${Math.sin(h.angle)*3}px)`;
        });
        requestAnimationFrame(animate);
    }
</script>
</body>
</html>
