<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–ê–ó–ê 11.5 - STABLE AI</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --accent: #ff9d00; --bg: #0e120a; --panel: rgba(26, 29, 22, 0.98); }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; color: #e0e0e0; }
        #mode-selector { position: fixed; inset: 0; z-index: 10000; background: #0e120a; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
        .mode-btn { padding: 20px; font-size: 20px; font-weight: bold; border-radius: 12px; border: none; cursor: pointer; width: 280px; }
        #main-container { display: flex; width: 100vw; height: 100vh; position: relative; }
        #forest { flex: 1; position: relative; overflow: hidden; }
        #bg-img { width: 100%; height: 100%; object-fit: contain; transition: transform 0.3s; }
        #hero-layer { position: absolute; inset: 0; z-index: 2; pointer-events: none; }
        #scanner { position: absolute; right: 0; top: 0; bottom: 0; width: 320px; background: var(--panel); backdrop-filter: blur(15px); z-index: 100; transition: transform 0.4s; padding: 15px; display: flex; flex-direction: column; border-left: 2px solid var(--accent); }
        #scanner.collapsed { transform: translateX(100%); }
        #toggle-panel { position: absolute; left: -45px; top: 20px; width: 45px; height: 45px; background: var(--panel); border: 2px solid var(--accent); border-right: none; color: var(--accent); cursor: pointer; border-radius: 10px 0 0 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .group { background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #333; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: #3d4435; color: white; margin-top: 5px; }
        .hero-card { background: #2a2d26; border-radius: 8px; padding: 8px; margin-top: 8px; border-left: 3px solid var(--accent); }
        .hero { position: absolute; will-change: transform; }
        body.is-remote #forest { display: none; }
        body.is-remote #scanner { position: relative; width: 100%; transform: none; border: none; }
        body.is-remote #toggle-panel { display: none; }
    </style>
</head>
<body>

<div id="mode-selector">
    <h2 style="color:var(--accent)">–ë–ê–ó–ê 11.5</h2>
    <button onclick="selectMode('screen')" class="mode-btn">üíª –≠–ö–†–ê–ù</button>
    <button onclick="selectMode('remote')" class="mode-btn" style="background:var(--accent); color:black;">üì± –ü–£–õ–¨–¢</button>
</div>

<div id="main-container">
    <div id="forest">
        <div style="position:absolute; width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
            <img id="bg-img" src="https://images.unsplash.com/photo-1511497584788-876760111969?auto=format&fit=crop&w=1500&q=80">
        </div>
        <div id="hero-layer"></div>
        <audio id="forest-audio" loop crossorigin="anonymous" playsinline></audio>
    </div>

    <div id="scanner" class="hidden">
        <button id="toggle-panel" onclick="$('scanner').classList.toggle('collapsed')">‚öôÔ∏è</button>
        <div id="db-status" style="font-size:10px; text-align:center; color: var(--accent); margin-bottom:5px;">–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø...</div>

        <div class="group">
            <h4>üå≤ –õ–µ—Å</h4>
            <input type="range" id="zoom-range" min="50" max="300" value="100" oninput="dbRef.child('world').update({zoom: this.value})">
            <button onclick="$('bg-in').click()">üñºÔ∏è –§–æ–Ω</button>
            <input type="file" id="bg-in" hidden accept="image/*" onchange="upload(this.files[0], 'bg')">
        </div>

        <div class="group">
            <h4>üëæ –ù–æ–≤—ã–π –≥–µ—Ä–æ–π</h4>
            <input type="text" id="api-key" placeholder="remove.bg key" style="width:100%; padding:8px; background:#000; border:1px solid #444; color:#fff; margin-bottom:5px; border-radius:4px; font-size:11px;">
            <button id="ai-btn" onclick="$('hero-in').click()" style="background: var(--accent); color: black;">üì∏ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å</button>
            <input type="file" id="hero-in" hidden accept="image/*" capture="camera" onchange="processHero(this.files[0])">
        </div>
        
        <div id="hero-editor-list" style="overflow-y: auto; flex: 1;"></div>
        <button onclick="dbRef.child('heroes').remove()" style="background: #442222; font-size: 10px; margin-top:5px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö</button>
    </div>
</div>

<script>
    const $ = id => document.getElementById(id);
    const firebaseConfig = {
        apiKey: "AIzaSyAOdgn7U8MKRbroByVJJXyL2NgQS405M64",
        authDomain: "lesbaza-d8fc9.firebaseapp.com",
        projectId: "lesbaza-d8fc9",
        databaseURL: "https://lesbaza-d8fc9-default-rtdb.firebaseio.com/"
    };

    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref('forest_session');
    let isRemote = false; let heroes = [];

    firebase.database().ref('.info/connected').on('value', snap => {
        $('db-status').innerText = snap.val() ? "–ë–ê–ó–ê: –û–ù–õ–ê–ô–ù ‚úÖ" : "–ë–ê–ó–ê: –û–§–§–õ–ê–ô–ù ‚ùå";
    });

    function selectMode(mode) {
        $('mode-selector').style.display = 'none';
        $('scanner').classList.remove('hidden');
        isRemote = (mode === 'remote');
        if (isRemote) document.body.classList.add('is-remote');
        const unlock = () => { $('forest-audio').play().catch(()=>{}); window.removeEventListener('mousedown', unlock); };
        window.addEventListener('mousedown', unlock);
        setupSync(); requestAnimationFrame(animate);
    }

    async function processHero(file) {
        if (!file) return;
        const key = $('api-key').value;
        const btn = $('ai-btn');
        btn.disabled = true; btn.innerText = "‚è≥ –°–ñ–ê–¢–ò–ï...";

        try {
            // 1. –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ–µ —Å–∂–∞—Ç–∏–µ (600px, 0.6 quality)
            const compressedBlob = await compressImage(file, 600, 0.6);
            let imgData = "";

            if (key) {
                btn.innerText = "‚è≥ –í–´–†–ï–ó–ö–ê –ò–ò...";
                const formData = new FormData();
                formData.append('image_file', compressedBlob);
                formData.append('size', 'preview');

                const res = await fetch('https://api.remove.bg/v1.1/removebg', {
                    method: 'POST', headers: { 'X-Api-Key': key }, body: formData
                });
                
                if (res.ok) {
                    const blob = await res.blob();
                    imgData = await blobToBase64(blob);
                } else {
                    console.log("AI Error, adding original");
                }
            }
            
            // –ï—Å–ª–∏ –ò–ò –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –±–µ—Ä–µ–º —Å–∂–∞—Ç—ã–π –æ—Ä–∏–≥–∏–Ω–∞–ª
            if (!imgData) imgData = await blobToBase64(compressedBlob);

            const id = 'h' + Date.now();
            await dbRef.child('heroes').child(id).set({
                src: imgData, x: 50, y: Math.random()*300+100, size: 150, speed: 10, dx: 1
            });
        } catch (e) {
            console.error(e);
            alert("–û—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
        } finally {
            btn.disabled = false; btn.innerText = "üì∏ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å";
        }
    }

    function compressImage(file, maxSize, quality) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > h) { if (w > maxSize) { h *= maxSize / w; w = maxSize; } }
                    else { if (h > maxSize) { w *= maxSize / h; h = maxSize; } }
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    canvas.toBlob(resolve, 'image/jpeg', quality);
                };
            };
        });
    }

    function blobToBase64(blob) {
        return new Promise((r) => { const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(blob); });
    }

    function upload(file, type) {
        if (!file) return;
        const rd = new FileReader();
        rd.onload = () => dbRef.child('world').update({ [type]: rd.result });
        rd.readAsDataURL(file);
    }

    function setupSync() {
        dbRef.on('value', snap => {
            const d = snap.val() || {};
            if (d.world) {
                if (d.world.zoom) { $('bg-img').style.transform = `scale(${d.world.zoom/100})`; $('zoom-range').value = d.world.zoom; }
                if (d.world.bg) $('bg-img').src = d.world.bg;
                if (d.world.audio && $('forest-audio').src !== d.world.audio) { $('forest-audio').src = d.world.audio; $('forest-audio').play(); }
                if (d.world.volume !== undefined) $('forest-audio').volume = d.world.volume;
            }
            const cloud = d.heroes || {};
            $('hero-editor-list').innerHTML = Object.keys(cloud).map(id => `
                <div class="hero-card">
                    <span style="font-size:10px;">–ì–µ—Ä–æ–π ${id.slice(-3)}</span>
                    <button onclick="firebase.database().ref('forest_session/heroes/${id}').remove()" style="width:20px; float:right; background:#622;">√ó</button>
                    <input type="range" min="50" max="400" value="${cloud[id].size}" oninput="dbRef.child('heroes').child('${id}').update({size: parseInt(this.value)})">
                </div>
            `).join('');
            if (!isRemote) {
                heroes.forEach(h => { if (!cloud[h.id]) { h.el.remove(); h.deleted = true; } });
                heroes = heroes.filter(h => !h.deleted);
                Object.keys(cloud).forEach(id => {
                    let h = heroes.find(x => x.id === id);
                    if (!h) {
                        const img = document.createElement('img'); img.src = cloud[id].src; img.className = 'hero';
                        $('hero-layer').appendChild(img); h = { id, el: img }; heroes.push(h);
                    }
                    const c = cloud[id]; h.x = c.x; h.y = c.y; h.size = c.size; h.speed = c.speed; h.dx = c.dx;
                    h.el.style.width = h.size + 'px';
                });
            }
        });
    }

    function animate() {
        if (!isRemote) {
            const vw = $('forest').clientWidth;
            heroes.forEach(h => {
                if(h.speed > 0) {
                    h.x += (h.speed / 10) * h.dx;
                    if (h.x > vw + 200) h.x = -200;
                    if (h.x < -200) h.x = vw;
                    h.el.style.transform = `translate(${h.x}px, ${h.y}px) scaleX(${h.dx > 0 ? -1 : 1})`;
                } else { h.el.style.transform = `translate(${h.x}px, ${h.y}px) scaleX(${h.dx > 0 ? -1 : 1})`; }
            });
        }
        requestAnimationFrame(animate);
    }
</script>
</body>
</html>
