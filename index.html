<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–ê–ó–ê 10.2 - –°–ò–ù–•–†–û –§–ò–ö–°</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --accent: #ff9d00; --bg: #0e120a; --panel: #1a1d16; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; color: #e0e0e0; }
        
        /* –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ */
        #mode-selector { position: fixed; inset: 0; z-index: 9999; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
        .mode-btn { padding: 20px 40px; font-size: 20px; font-weight: bold; border-radius: 15px; border: none; cursor: pointer; width: 280px; }

        #main-container { display: flex; width: 100vw; height: 100vh; flex-direction: column; }
        @media (min-width: 768px) { #main-container { flex-direction: row; } }

        #forest { flex: 1; position: relative; overflow: hidden; background: #050505; }
        
        #bg-media-container { position: absolute; width: 100%; height: 100%; z-index: 1; display: flex; align-items: center; justify-content: center; transform-origin: bottom center; }
        #bg-img, #bg-video { width: 100%; height: 100%; object-fit: contain; transition: transform 0.1s; display: block; }

        @keyframes wind-sway { 0%, 100% { transform: skewX(0deg); } 50% { transform: skewX(var(--wind-power, 2deg)); } }
        .sway-active { animation: wind-sway 6s ease-in-out infinite; }
        #hero-layer { position: absolute; inset: 0; z-index: 2; pointer-events: none; }

        /* –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        #scanner { width: 100%; background: var(--panel); display: flex; flex-direction: column; padding: 15px; z-index: 10; overflow-y: auto; border-left: 2px solid #2d3326; }
        @media (min-width: 768px) { #scanner { width: 350px; height: 100vh; } }
        
        .hidden { display: none !important; }

        .camera-box { position: relative; width: 120px; aspect-ratio: 1/1; border-radius: 12px; overflow: hidden; border: 2px solid #444; margin: 0 auto 10px; background: #111; }
        video#camera-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        .group { background: #22261d; padding: 12px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #333; }
        .group-title { font-size: 10px; color: #888; text-transform: uppercase; margin-bottom: 8px; font-weight: bold; }
        label { font-size: 10px; color: #666; display: block; margin-top: 10px; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-top: 5px; background: #3d4435; color: white; }
        input[type="range"] { width: 100%; accent-color: var(--accent); margin-top: 5px; }
        .hero { position: absolute; will-change: transform; }
        .journal-item { background: #151812; padding: 10px; border-radius: 8px; margin-top: 8px; border: 1px solid #444; }
    </style>
</head>
<body>

<div id="mode-selector">
    <button id="btn-screen" class="mode-btn" style="background:#3d4435; color:white;">üíª –†–ï–ñ–ò–ú –≠–ö–†–ê–ù–ê (–ü–†–û–ï–ö–¢–û–†)</button>
    <button id="btn-remote" class="mode-btn" style="background:var(--accent); color:black;">üì± –†–ï–ñ–ò–ú –ü–£–õ–¨–¢–ê (–¢–ï–õ–ï–§–û–ù)</button>
</div>

<div id="main-container">
    <div id="forest">
        <div id="bg-media-container" class="sway-active" style="--wind-power: 2deg;">
            <img id="bg-img" src="https://images.unsplash.com/photo-1511497584788-876760111969?auto=format&fit=crop&w=1500&q=80">
            <video id="bg-video" loop muted playsinline style="display:none;"></video>
        </div>
        <div id="hero-layer"></div>
    </div>

    <div id="scanner" class="hidden">
        <div class="camera-box"><video id="camera-feed" autoplay playsinline></video></div>
        
        <div class="group">
            <div class="group-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–µ—Å–∞</div>
            <button onclick="$('bg-in').click()">üñºÔ∏è –í–´–ë–†–ê–¢–¨ –§–û–ù/–í–ò–î–ï–û</button>
            <input type="file" id="bg-in" hidden accept="image/*,video/*">
            <label>–ó–£–ú (–ú–ê–°–®–¢–ê–ë):</label>
            <input type="range" id="bg-zoom" min="50" max="250" value="100" oninput="updateWorld('zoom', this.value)">
            <label>–°–ò–õ–ê –í–ï–¢–†–ê:</label>
            <input type="range" id="wind-in" min="0" max="15" value="2" oninput="updateWorld('wind', this.value)">
        </div>

        <div class="group">
            <div class="group-title">–°–æ–∑–¥–∞—Ç—å –≥–µ—Ä–æ—è</div>
            <input type="password" id="api-key" placeholder="API Key (remove.bg)" style="width:100%; padding:10px; background:#111; color:#fff; border:1px solid #444; margin-bottom:10px; border-radius:5px;">
            <button id="scan-btn" style="background:var(--accent); color:black; height: 50px;">‚ú® –û–ñ–ò–í–ò–¢–¨ –° –ö–ê–ú–ï–†–´</button>
            <button onclick="$('hero-in').click()" style="background:#444; font-size:10px;">üìÇ –ó–ê–ì–†–£–ó–ò–¢–¨ –ì–ï–†–û–Ø –ò–ó –ì–ê–õ–ï–†–ï–ò</button>
            <input type="file" id="hero-in" hidden accept="image/*">
        </div>

        <div class="group-title" style="padding-left:10px;">–ì–µ—Ä–æ–∏ –≤ –ª–µ—Å—É:</div>
        <div id="hero-journal"></div>
    </div>
</div>

<canvas id="proc-canvas" style="display:none"></canvas>

<script>
    const $ = id => document.getElementById(id);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (–¢–≤–æ–π –∫–æ–Ω—Ñ–∏–≥)
    const firebaseConfig = {
        apiKey: "AIzaSyAOdgn7U8MKRbroByVJJXyL2NgQS405M64",
        authDomain: "lesbaza-d8fc9.firebaseapp.com",
        projectId: "lesbaza-d8fc9",
        storageBucket: "lesbaza-d8fc9.firebasestorage.app",
        messagingSenderId: "957259867268",
        appId: "1:957259867268:web:b1dda420365ee6a2460ed1",
        databaseURL: "https://lesbaza-d8fc9-default-rtdb.europe-west1.firebasedatabase.app/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref('forest_session');

    const state = { heroes: [], isRemote: false };

    // –ö–Ω–æ–ø–∫–∏ —Ä–µ–∂–∏–º–∞
    $('btn-screen').onclick = () => { $('mode-selector').remove(); $('scanner').remove(); startApp(false); };
    $('btn-remote').onclick = () => { $('mode-selector').remove(); $('scanner').classList.remove('hidden'); $('forest').classList.add('hidden'); startApp(true); };

    function startApp(remote) {
        state.isRemote = remote;
        if(remote) initCamera();
        
        db.on('value', snap => {
            const data = snap.val() || {};
            if(data.world) syncWorld(data.world);
            syncHeroes(data.heroes || {});
        });
        requestAnimationFrame(animate);
    }

    function syncWorld(w) {
        if(w.zoom) {
            const s = w.zoom / 100;
            $('bg-img').style.transform = `scale(${s})`;
            $('bg-video').style.transform = `scale(${s})`;
        }
        if(w.wind !== undefined) $('bg-media-container').style.setProperty('--wind-power', w.wind + 'deg');
        if(w.bgSrc && $('bg-img').src !== w.bgSrc && !state.isRemote) {
            if(w.isVid) {
                $('bg-img').style.display='none'; $('bg-video').style.display='block';
                $('bg-video').src = w.bgSrc; $('bg-video').play();
            } else {
                $('bg-video').style.display='none'; $('bg-img').style.display='block';
                $('bg-img').src = w.bgSrc;
            }
        }
    }

    function updateWorld(field, val) { db.child('world').update({ [field]: parseInt(val) }); }

    $('bg-in').onchange = e => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
            db.child('world').update({ bgSrc: reader.result, isVid: file.type.startsWith('video') });
        };
        reader.readAsDataURL(file);
    };

    async function initCamera() {
        try {
            const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            $('camera-feed').srcObject = s;
        } catch(e) { alert("–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"); }
    }

    function syncHeroes(cloudHeroes) {
        state.heroes.forEach(h => { if(!cloudHeroes[h.id]) { h.el.remove(); h.deleted = true; } });
        state.heroes = state.heroes.filter(h => !h.deleted);

        Object.keys(cloudHeroes).forEach(id => {
            const d = cloudHeroes[id];
            let h = state.heroes.find(x => x.id == id);
            if(!h) {
                const img = document.createElement('img');
                img.src = d.src; img.className = 'hero';
                $('hero-layer').appendChild(img);
                h = { id, el: img, angle: Math.random()*5 };
                state.heroes.push(h);
                if(state.isRemote) addJournalItem(id);
            }
            h.x = d.x; h.y = d.y; h.size = d.size; h.speed = d.speed; h.dx = d.dx;
            h.el.style.width = h.size + 'px';
        });
    }

    $('scan-btn').onclick = async () => {
        const key = $('api-key').value;
        if(!key) return alert("–í–≤–µ–¥–∏—Ç–µ API KEY");
        const canv = $('proc-canvas'); const ctx = canv.getContext('2d'); const v = $('camera-feed');
        canv.width = 600; canv.height = 600;
        ctx.drawImage(v, 0, 0, 600, 600);
        canv.toBlob(async blob => {
            const fd = new FormData(); fd.append('image_file', blob);
            try {
                const res = await fetch('https://api.remove.bg/v1.0/removebg', { method: 'POST', headers: { 'X-Api-Key': key }, body: fd });
                if(res.ok) {
                    const r = new FileReader(); r.readAsDataURL(await res.blob());
                    r.onloadend = () => db.child('heroes').child(Date.now()).set({src: r.result, x: 100, y: 350, size: 120, speed: 10, dx: 1});
                } else alert("–û—à–∏–±–∫–∞ API (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á)");
            } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
        });
    };

    $('hero-in').onchange = e => {
        const r = new FileReader();
        r.onload = () => db.child('heroes').child(Date.now()).set({src: r.result, x: 100, y: 350, size: 120, speed: 10, dx: 1});
        r.readAsDataURL(e.target.files[0]);
    };

    function addJournalItem(id) {
        if($('item-'+id)) return;
        const div = document.createElement('div');
        div.className = 'journal-item'; div.id = 'item-'+id;
        div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:10px">–ì–ï–†–û–ô #${id.toString().slice(-4)}</span>
            <button onclick="db.child('heroes').child(${id}).remove()" style="width:30px; margin:0; padding:2px; background:#632222">‚úñ</button>
        </div>
        <label>–†–∞–∑–º–µ—Ä:</label>
        <input type="range" min="40" max="400" value="120" onchange="db.child('heroes').child(${id}).update({size: parseInt(this.value)})">
        <label>–°–∫–æ—Ä–æ—Å—Ç—å:</label>
        <input type="range" min="0" max="50" value="10" onchange="db.child('heroes').child(${id}).update({speed: parseInt(this.value)})">`;
        $('hero-journal').appendChild(div);
    }

    function animate() {
        const viewW = $('forest').clientWidth;
        if(!state.isRemote) {
            state.heroes.forEach(h => {
                h.x += (h.speed / 10) * h.dx;
                if(h.x > viewW) h.x = -h.size;
                if(h.x < -h.size) h.x = viewW;
                h.el.style.transform = `translate(${h.x}px, ${h.y}px) scaleX(${h.dx > 0 ? -1 : 1})`;
            });
        }
        requestAnimationFrame(animate);
    }
</script>
</body>
</html>
