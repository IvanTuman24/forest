<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–õ–ï–° 16.0 - FULL AI</title>
    <style>
        :root { --accent: #2e8b57; --panel: #1a1d16; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; color: #e0e0e0; }
        #main-container { display: flex; width: 100vw; height: 100vh; position: relative; }
        #forest { flex: 1; position: relative; overflow: hidden; background: #000; }
        #bg-media-container { position: absolute; width: 100%; height: 100%; z-index: 1; display: flex; align-items: center; justify-content: center; transform-origin: center center; }
        #bg-img, #bg-video { width: auto; height: auto; min-width: 100%; min-height: 100%; display: block; }
        #bg-video { display: none; }
        @keyframes wind-sway { 0%, 100% { transform: skewX(0deg); } 50% { transform: skewX(var(--wind-power, 2deg)); } }
        .sway-active { animation: wind-sway var(--wind-speed, 6s) ease-in-out infinite; }
        #hero-layer { position: absolute; inset: 0; z-index: 2; pointer-events: none; }
        #side-panel { position: fixed; right: 0; top: 0; bottom: 0; width: 320px; background: var(--panel); z-index: 100; border-left: 2px solid #2d3326; transition: transform 0.4s ease; display: flex; flex-direction: column; }
        #side-panel.hidden { transform: translateX(100%); }
        #toggle-panel { position: absolute; left: -45px; top: 20px; width: 45px; height: 50px; background: var(--panel); border: 2px solid #2d3326; border-right: none; color: var(--accent); cursor: pointer; border-radius: 10px 0 0 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        #scanner-content { flex: 1; overflow-y: auto; padding: 15px; }
        .camera-box { position: relative; width: 100%; aspect-ratio: 1/1; border-radius: 10px; overflow: hidden; border: 2px solid #444; background: #111; margin-bottom: 10px; }
        video#camera-feed { width: 100%; height: 100%; object-fit: cover; }
        .camera-overlay { position: absolute; inset: 0; border: 50px solid rgba(0,0,0,0.7); pointer-events: none; }
        .camera-overlay::after { content: ''; position: absolute; inset: 0; border: 3px solid var(--accent); }
        #ai-status { background: rgba(46,139,87,0.1); color: var(--accent); padding: 8px; border-radius: 6px; border: 1px solid var(--accent); font-size: 11px; text-align: center; margin-bottom: 10px; min-height: 32px; }
        .group { background: #22261d; padding: 12px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #333; }
        .group-title { font-size: 10px; text-transform: uppercase; color: #777; margin-bottom: 8px; font-weight: bold; }
        button { width: 100%; padding: 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; background: #3d4435; color: white; font-size: 11px; margin-top: 5px; }
        .btn-main { background: var(--accent) !important; color: #000 !important; }
        input[type="range"] { width: 100%; accent-color: var(--accent); margin-top: 8px; }
        .hero { position: absolute; will-change: transform; transform-origin: center bottom; }
        .journal-item { background: #151812; padding: 10px; border-radius: 8px; margin-top: 8px; border: 1px solid #333; display: flex; gap: 10px; align-items: center; }
        .hero-mini { width: 50px; height: 50px; border-radius: 6px; background: #000; object-fit: contain; }
    </style>
</head>
<body>

<div id="main-container">
    <div id="forest">
        <div id="bg-media-container" class="sway-active" style="--wind-power: 2deg; --wind-speed: 6s;">
            <img id="bg-img" src="https://images.unsplash.com/photo-1511497584788-876760111969?auto=format&fit=crop&w=1500&q=80">
            <video id="bg-video" loop muted playsinline></video>
        </div>
        <div id="hero-layer"></div>
    </div>

    <div id="side-panel">
        <div id="toggle-panel" onclick="togglePanel()">‚óÄ</div>
        <div id="scanner-content">
            <div class="camera-box">
                <video id="camera-feed" autoplay playsinline></video>
                <div class="camera-overlay"></div>
            </div>
            
            <div id="ai-status">–°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê</div>

            <div class="group">
                <div class="group-title">–ò–ò –û–ë–†–ê–ë–û–¢–ö–ê (Remove.bg)</div>
                <input type="password" id="api-key" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ API –ö–ª—é—á" style="width:100%; padding:8px; background:#000; color:#fff; border:1px solid #444; border-radius:4px; margin-bottom:10px;">
                
                <button class="btn-main" onclick="processAIFromCamera()">‚úÇÔ∏è –í–´–†–ï–ó–ê–¢–¨ –° –ö–ê–ú–ï–†–´</button>
                
                <button class="btn-main" style="background:#572e8b !important; color:white !important; margin-top:10px;" onclick="$('hero-pc').click()">üìÇ –ó–ê–ì–†–£–ó–ò–¢–¨ –ò –û–ë–†–ï–ó–ê–¢–¨ –° –ü–ö</button>
                <input type="file" id="hero-pc" hidden accept="image/*" onchange="processAIFromFile(this)">
            </div>

            <div class="group">
                <div class="group-title">–§–æ–Ω –∏ –û–∫—Ä—É–∂–µ–Ω–∏–µ</div>
                <button onclick="$('bg-in').click()">üñºÔ∏è –°–ú–ï–ù–ò–¢–¨ –§–û–ù</button>
                <input type="file" id="bg-in" hidden accept="image/*,video/*" onchange="loadBg(this)">
                
                <label style="font-size: 9px; color: #555;">–ú–ê–°–®–¢–ê–ë</label>
                <input type="range" id="bg-zoom" min="50" max="300" value="100" oninput="applyBg()">
                <label style="font-size: 9px; color: #555;">–í–ï–¢–ï–†</label>
                <input type="range" id="wind-speed-in" min="1" max="20" value="15" oninput="applyWindSpeed(this.value)">
            </div>

            <div id="hero-journal"></div>
        </div>
    </div>
</div>

<canvas id="proc-canvas" style="display:none"></canvas>

<script>
    const $ = id => document.getElementById(id);
    let heroes = [];
    let lineCounter = 0;

    function togglePanel() {
        $('side-panel').classList.toggle('hidden');
        $('toggle-panel').innerText = $('side-panel').classList.contains('hidden') ? '‚ñ∂' : '‚óÄ';
    }

    function setAIStatus(msg) { $('ai-status').innerText = msg; }

    async function init() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: 1280, height: 720 } });
            $('camera-feed').srcObject = stream;
        } catch(e) { setAIStatus("–û–®–ò–ë–ö–ê –ö–ê–ú–ï–†–´"); }
        requestAnimationFrame(animate);
    }

    // --- –û–ë–©–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –í –ò–ò ---
    async function sendToRemoveBG(blob) {
        const key = $('api-key').value;
        if(!key) { setAIStatus("‚ùå –ù–ï–¢ API –ö–õ–Æ–ß–ê!"); return; }
        
        setAIStatus("üöÄ –ò–ò –í–´–†–ï–ó–ê–ï–¢ –ì–ï–†–û–Ø...");
        const fd = new FormData();
        fd.append('image_file', blob);
        fd.append('size', 'auto');

        try {
            const res = await fetch('https://api.remove.bg/v1.0/removebg', {
                method: 'POST',
                headers: { 'X-Api-Key': key },
                body: fd
            });

            if(res.ok) {
                const resultBlob = await res.blob();
                addHero(URL.createObjectURL(resultBlob));
                setAIStatus("‚ú® –ì–û–¢–û–í–û!");
            } else {
                const err = await res.json();
                setAIStatus("‚ùå " + err.errors[0].title);
            }
        } catch(e) { setAIStatus("‚ùå –û–®–ò–ë–ö–ê –°–ï–¢–ò"); }
    }

    // --- –û–ë–†–ê–ë–û–¢–ö–ê –° –ö–ê–ú–ï–†–´ ---
    function processAIFromCamera() {
        const canv = $('proc-canvas'); const ctx = canv.getContext('2d'); const v = $('camera-feed');
        const size = 800; canv.width = size; canv.height = size;
        
        const vW = v.videoWidth, vH = v.videoHeight;
        const sSize = Math.min(vW, vH) * 0.7;
        const sX = (vW - sSize) / 2;
        const sY = (vH - sSize) / 2;

        ctx.filter = "contrast(1.4) brightness(1.1)";
        ctx.drawImage(v, sX, sY, sSize, sSize, 0, 0, size, size);
        canv.toBlob(blob => sendToRemoveBG(blob), 'image/png');
    }

    // --- –û–ë–†–ê–ë–û–¢–ö–ê –° –§–ê–ô–õ–ê –ü–ö ---
    function processAIFromFile(input) {
        const file = input.files[0];
        if(!file) return;

        setAIStatus("‚è≥ –ü–û–î–ì–û–¢–û–í–ö–ê –§–ê–ô–õ–ê...");
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canv = $('proc-canvas'); const ctx = canv.getContext('2d');
                canv.width = img.width; canv.height = img.height;
                ctx.drawImage(img, 0, 0);
                canv.toBlob(blob => sendToRemoveBG(blob), 'image/png');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function addHero(src) {
        const id = Date.now();
        const el = document.createElement('img');
        el.src = src; el.className = 'hero';
        
        const line = lineCounter++ % 2;
        const forestH = $('forest').clientHeight;
        const posY = line === 0 ? forestH * 0.45 : forestH * 0.85;
        const dSize = line === 0 ? 120 : 180;
        
        el.style.width = dSize + 'px';
        el.style.zIndex = line === 0 ? 2 : 5; 
        $('hero-layer').appendChild(el);
        
        heroes.push({ id, el, x: Math.random() * 200, y: posY, dx: 1, size: dSize, speed: 10, angle: Math.random()*10, line });
        
        const div = document.createElement('div');
        div.className = 'journal-item'; div.id = 'item-'+id;
        div.innerHTML = `<img src="${src}" class="hero-mini">
            <div style="flex:1">
                <input type="range" min="30" max="600" value="${dSize}" oninput="updateH(${id},'size',this.value)">
                <input type="range" min="0" max="60" value="10" oninput="updateH(${id},'speed',this.value)">
            </div>
            <button onclick="delHero(${id})" style="width:20px; background:#ff4444">√ó</button>`;
        $('hero-journal').appendChild(div);
    }

    function applyBg() {
        const s = `scale(${$('bg-zoom').value / 100})`;
        $('bg-img').style.transform = s; $('bg-video').style.transform = s;
    }
    
    function applyWindSpeed(v) { $('bg-media-container').style.setProperty('--wind-speed', (21 - v) / 2 + 's'); }

    function loadBg(i) {
        const f = i.files[0]; if(!f) return;
        const u = URL.createObjectURL(f);
        if(f.type.startsWith('video')) { $('bg-img').style.display='none'; $('bg-video').style.display='block'; $('bg-video').src=u; $('bg-video').play(); }
        else { $('bg-video').style.display='none'; $('bg-img').style.display='block'; $('bg-img').src=u; }
    }

    window.updateH = (id, t, v) => {
        const h = heroes.find(x => x.id === id); if(!h) return;
        if(t === 'size') { h.size = v; h.el.style.width = v + 'px'; }
        if(t === 'speed') h.speed = v;
    };

    window.delHero = id => {
        const i = heroes.findIndex(x => x.id === id);
        if(i > -1) { heroes[i].el.remove(); heroes.splice(i, 1); $('item-'+id).remove(); }
    };

    function animate() {
        const forestW = $('forest').clientWidth;
        heroes.forEach(h => {
            h.x += (h.speed / 10);
            if (h.x > forestW) h.x = -h.size;
            h.angle += 0.05;
            // –ù–æ–≥–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –ª–∏–Ω–∏–∏ (y), —Å–ø—Ä–∞–π—Ç —Ä–∞—Å—Ç–µ—Ç –≤–≤–µ—Ä—Ö
            h.el.style.transform = `translate(${h.x}px, ${h.y - h.size + Math.sin(h.angle)*4}px)`;
        });
        requestAnimationFrame(animate);
    }

    init();
</script>
</body>
</html>
