<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–õ–ï–° 17.0 - CONNECT</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --accent: #2e8b57; --panel: #1a1d16; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; color: #e0e0e0; }
        
        /* –°–¢–ê–†–¢–û–í–û–ï –ú–ï–ù–Æ */
        #mode-selector { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
        .mode-btn { width: 280px; padding: 40px; border-radius: 20px; border: 2px solid var(--accent); background: #111; color: white; cursor: pointer; text-align: center; }
        .mode-btn h2 { margin-bottom: 10px; color: var(--accent); }

        /* –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† */
        #main-container { display: flex; width: 100vw; height: 100vh; position: relative; }
        #forest { flex: 1; position: relative; overflow: hidden; }
        #bg-media-container { position: absolute; width: 100%; height: 100%; z-index: 1; display: flex; align-items: center; justify-content: center; }
        #bg-img { min-width: 100%; min-height: 100%; object-fit: cover; }
        #hero-layer { position: absolute; inset: 0; z-index: 2; pointer-events: none; }

        /* –ü–ê–ù–ï–õ–¨ */
        #side-panel { position: fixed; right: 0; top: 0; bottom: 0; width: 320px; background: var(--panel); z-index: 100; border-left: 2px solid #2d3326; transition: 0.4s; display: flex; flex-direction: column; }
        #side-panel.hidden { transform: translateX(100%); }
        #toggle-panel { position: absolute; left: -45px; top: 20px; width: 45px; height: 50px; background: var(--panel); border: 2px solid #2d3326; border-right: none; color: var(--accent); cursor: pointer; border-radius: 10px 0 0 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        
        #scanner-content { flex: 1; overflow-y: auto; padding: 15px; }
        .group { background: #22261d; padding: 12px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #333; }
        button { width: 100%; padding: 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; background: #3d4435; color: white; margin-top: 5px; font-size: 11px; }
        .btn-main { background: var(--accent) !important; color: #000 !important; }
        
        /* QR –ö–û–î */
        #qr-overlay { position: absolute; top: 20px; left: 20px; padding: 10px; background: white; border-radius: 10px; z-index: 1000; display: none; text-align: center; }
        #qr-overlay img { width: 150px; height: 150px; }
        #qr-overlay span { color: #000; font-size: 10px; font-weight: bold; display: block; margin-top: 5px; }

        #ai-status { background: rgba(46,139,87,0.1); color: var(--accent); padding: 8px; border-radius: 6px; border: 1px solid var(--accent); font-size: 11px; text-align: center; margin-bottom: 10px; }
        .hero { position: absolute; will-change: transform; transform-origin: center bottom; }
        .journal-item { background: #151812; padding: 10px; border-radius: 8px; margin-top: 8px; border: 1px solid #333; display: flex; gap: 10px; align-items: center; }
        .hero-mini { width: 40px; height: 40px; object-fit: contain; }
    </style>
</head>
<body>

<div id="mode-selector">
    <div class="mode-btn" onclick="startMode('screen')">
        <h2>üñ•Ô∏è –≠–ö–†–ê–ù</h2>
        <p>–û—Å–Ω–æ–≤–Ω–æ–π –ª–µ—Å (–¥–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞)</p>
    </div>
    <div class="mode-btn" onclick="startMode('device')">
        <h2>üì± –£–°–¢–†–û–ô–°–¢–í–û</h2>
        <p>–ü—É–ª—å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ (–¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞)</p>
    </div>
</div>

<div id="main-container">
    <div id="forest">
        <div id="qr-overlay">
            <div id="qr-code"></div>
            <span>–°–ö–ê–ù–ï–† –î–õ–Ø –¢–ï–õ–ï–§–û–ù–ê</span>
        </div>
        <div id="bg-media-container">
            <img id="bg-img" src="https://images.unsplash.com/photo-1511497584788-876760111969?auto=format&fit=crop&w=1500&q=80">
        </div>
        <div id="hero-layer"></div>
    </div>

    <div id="side-panel">
        <div id="toggle-panel" onclick="togglePanel()">‚óÄ</div>
        <div id="scanner-content">
            <div id="ai-status">–°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê</div>
            
            <div class="group" id="local-controls">
                <input type="password" id="api-key" placeholder="API Key Remove.bg" style="width:100%; padding:8px; margin-bottom:10px; background:#000; color:#fff; border:1px solid #444;">
                <button class="btn-main" onclick="$('hero-pc').click()">üìÇ –ó–ê–ì–†–£–ó–ò–¢–¨ –ì–ï–†–û–Ø</button>
                <input type="file" id="hero-pc" hidden accept="image/*" onchange="processAIFromFile(this)">
            </div>

            <div class="group">
                <button onclick="showQR()">üì≤ –ü–û–î–ö–õ–Æ–ß–ò–¢–¨ –¢–ï–õ–ï–§–û–ù</button>
            </div>

            <div id="hero-journal"></div>
        </div>
    </div>
</div>

<canvas id="proc-canvas" style="display:none"></canvas>

<script>
    const $ = id => document.getElementById(id);
    let heroes = [];
    let peer, conn;
    let myRole = '';

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –†–ï–ñ–ò–ú–ê ---
    function startMode(role) {
        myRole = role;
        $('mode-selector').style.display = 'none';
        
        if (role === 'device') {
            // –†–µ–∂–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞: —Å–∫—Ä—ã–≤–∞–µ–º –ª–µ—Å, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—É–ª—å—Ç
            $('forest').style.display = 'none';
            $('side-panel').style.width = '100%';
            $('side-panel').classList.remove('hidden');
            $('toggle-panel').style.display = 'none';
            initRemote(null); // –ñ–¥–µ–º –≤–≤–æ–¥–∞ ID –∏–ª–∏ —Å–∫–∞–Ω–∞
        } else {
            initRemote('forest-screen-123'); // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ID –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
        }
        requestAnimationFrame(animate);
    }

    // --- –°–í–Ø–ó–¨ PEERJS ---
    function initRemote(id) {
        peer = new Peer(id);
        
        peer.on('open', (myId) => {
            if (myRole === 'device') {
                const urlParams = new URLSearchParams(window.location.search);
                const connectTo = urlParams.get('connect');
                if (connectTo) connect(connectTo);
                else {
                    const target = prompt("–í–≤–µ–¥–∏—Ç–µ ID –≠–∫—Ä–∞–Ω–∞ –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∑–∞–Ω–æ–≤–æ", "forest-screen-123");
                    connect(target);
                }
            }
        });

        peer.on('connection', (c) => {
            conn = c;
            setAIStatus("üì± –¢–ï–õ–ï–§–û–ù –ü–û–î–ö–õ–Æ–ß–ï–ù");
            conn.on('data', (data) => {
                if (data.type === 'new-hero') addHero(data.src);
            });
        });
    }

    function connect(targetId) {
        conn = peer.connect(targetId);
        conn.on('open', () => setAIStatus("‚úÖ –ü–û–î–ö–õ–Æ–ß–ï–ù–û –ö –≠–ö–†–ê–ù–£"));
    }

    function showQR() {
        const qrBox = $('qr-overlay');
        if (qrBox.style.display === 'block') { qrBox.style.display = 'none'; return; }
        
        const connectUrl = window.location.href.split('?')[0] + '?connect=forest-screen-123';
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(connectUrl)}`;
        $('qr-code').innerHTML = `<img src="${qrUrl}">`;
        qrBox.style.display = 'block';
    }

    // --- –õ–û–ì–ò–ö–ê –ò–ò ---
    async function processAIFromFile(input) {
        const file = input.files[0];
        if(!file) return;

        const key = $('api-key').value;
        if(!key) { alert("–í—Å—Ç–∞–≤—å API –ö–ª—é—á!"); return; }

        setAIStatus("üöÄ –ò–ò –û–ë–†–ê–ë–û–¢–ö–ê...");
        const fd = new FormData();
        fd.append('image_file', file);

        try {
            const res = await fetch('https://api.remove.bg/v1.0/removebg', {
                method: 'POST',
                headers: { 'X-Api-Key': key },
                body: fd
            });

            if(res.ok) {
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                
                if (myRole === 'device' && conn) {
                    // –ï—Å–ª–∏ –º—ã –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —ç–∫—Ä–∞–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ base64
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        conn.send({ type: 'new-hero', src: reader.result });
                        setAIStatus("‚ú® –û–¢–ü–†–ê–í–õ–ï–ù–û –ù–ê –≠–ö–†–ê–ù!");
                    };
                    reader.readAsDataURL(blob);
                } else {
                    addHero(url);
                    setAIStatus("‚ú® –ì–û–¢–û–í–û!");
                }
            }
        } catch(e) { setAIStatus("‚ùå –û–®–ò–ë–ö–ê"); }
    }

    // --- –õ–ï–° –ò –ì–ï–†–û–ò ---
    function addHero(src) {
        const id = Date.now();
        const el = document.createElement('img');
        el.src = src; el.className = 'hero';
        
        const forestH = $('forest').clientHeight;
        const line = heroes.length % 2;
        const posY = line === 0 ? forestH * 0.45 : forestH * 0.85;
        const dSize = line === 0 ? 120 : 180;
        
        el.style.width = dSize + 'px';
        el.style.zIndex = line === 0 ? 2 : 5; 
        $('hero-layer').appendChild(el);
        
        heroes.push({ id, el, x: -100, y: posY, size: dSize, speed: 10 + Math.random()*5, angle: 0 });
        
        const div = document.createElement('div');
        div.className = 'journal-item'; div.id = 'item-'+id;
        div.innerHTML = `<img src="${src}" class="hero-mini">
            <input type="range" min="30" max="500" value="${dSize}" oninput="updateH(${id},this.value)">
            <button onclick="delHero(${id})" style="width:30px; background:#ff4444">√ó</button>`;
        $('hero-journal').appendChild(div);
    }

    function togglePanel() { $('side-panel').classList.toggle('hidden'); }
    function setAIStatus(msg) { $('ai-status').innerText = msg; }
    
    window.updateH = (id, v) => {
        const h = heroes.find(x => x.id === id);
        if(h) { h.size = v; h.el.style.width = v + 'px'; }
    };

    window.delHero = id => {
        const i = heroes.findIndex(x => x.id === id);
        if(i > -1) { heroes[i].el.remove(); heroes.splice(i, 1); $('item-'+id).remove(); }
    };

    function animate() {
        const forestW = $('forest').clientWidth;
        heroes.forEach(h => {
            h.x += (h.speed / 20);
            if (h.x > forestW + 100) h.x = -h.size;
            h.angle += 0.05;
            h.el.style.transform = `translate(${h.x}px, ${h.y - h.size + Math.sin(h.angle)*3}px)`;
        });
        requestAnimationFrame(animate);
    }
</script>
</body>
</html>
