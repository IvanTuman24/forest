<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–õ–ï–° 19.0 - FINAL CONTROL</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --accent: #2e8b57; --panel: #141712; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; color: #e0e0e0; }
        
        /* –°–¢–ê–†–¢–û–í–´–ô –í–´–ë–û–† */
        #selector { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
        .mode-card { width: 300px; padding: 30px; border: 2px solid var(--accent); background: #111; border-radius: 15px; cursor: pointer; text-align: center; }

        #main-container { display: flex; width: 100vw; height: 100vh; position: relative; }
        
        /* –õ–ï–° (–≠–ö–†–ê–ù) */
        #forest { flex: 1; position: relative; overflow: hidden; }
        #bg-wrap { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; }
        #bg-media { min-width: 100%; min-height: 100%; object-fit: cover; }
        #hero-layer { position: absolute; inset: 0; z-index: 10; pointer-events: none; }

        /* –í–ï–¢–ï–† */
        @keyframes sway { 0%, 100% { transform: skewX(0deg); } 50% { transform: skewX(var(--wp, 2deg)); } }
        .sway { animation: sway var(--ws, 6s) ease-in-out infinite; }

        /* –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        #side-panel { width: 340px; background: var(--panel); border-left: 2px solid #2d3326; position: relative; transition: transform 0.4s; z-index: 100; display: flex; flex-direction: column; }
        #side-panel.hidden { transform: translateX(340px); margin-left: -340px; }
        #btn-toggle { position: absolute; left: -45px; top: 20px; width: 45px; height: 50px; background: var(--panel); border: 2px solid #2d3326; border-right: none; border-radius: 10px 0 0 10px; color: var(--accent); cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; }
        .group { background: #1c2118; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #333; }
        .group-name { font-size: 10px; font-weight: bold; color: var(--accent); text-transform: uppercase; margin-bottom: 10px; }

        #ai-status { background: rgba(46,139,87,0.1); color: var(--accent); padding: 10px; border-radius: 8px; border: 1px solid var(--accent); font-size: 11px; text-align: center; margin-bottom: 15px; }

        /* –í–ò–î–ï–û –ò –ì–ï–†–û–ò */
        .cam-preview { width: 100%; aspect-ratio: 4/3; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 10px; border: 1px solid #444; }
        #video-feed { width: 100%; height: 100%; object-fit: cover; }
        
        .hero { position: absolute; will-change: transform; transform-origin: center bottom; }
        .hero-card { display: flex; align-items: center; gap: 10px; background: #0a0c0a; padding: 10px; border-radius: 8px; margin-top: 5px; }
        .mini-img { width: 45px; height: 45px; object-fit: contain; background: #000; border-radius: 4px; }

        button { width: 100%; padding: 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; background: #333; color: #fff; margin-top: 5px; font-size: 11px; }
        .btn-green { background: var(--accent) !important; color: #000 !important; }
        input[type="range"] { width: 100%; accent-color: var(--accent); margin-top: 10px; }
        
        #qr-box { position: absolute; top: 20px; left: 20px; background: #fff; padding: 10px; border-radius: 10px; z-index: 1000; display: none; text-align: center; }
        #qr-box img { width: 140px; height: 140px; }
    </style>
</head>
<body>

<div id="selector">
    <div class="mode-card" onclick="initMode('screen')">
        <h2>üñ•Ô∏è –≠–ö–†–ê–ù</h2>
        <p>–ü–æ–ª–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –õ–µ—Å</p>
    </div>
    <div class="mode-card" onclick="initMode('phone')">
        <h2>üì± –ü–£–õ–¨–¢</h2>
        <p>–¢–æ–ª—å–∫–æ —Å–∫–∞–Ω–µ—Ä –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞</p>
    </div>
</div>

<div id="main-container">
    <div id="forest">
        <div id="qr-box"><div id="qr-code"></div><p style="color:#000; font-size:10px; margin-top:5px;">–ü–£–õ–¨–¢ –î–õ–Ø –¢–ï–õ–ï–§–û–ù–ê</p></div>
        <div id="bg-wrap" class="sway">
            <img id="bg-media" src="https://images.unsplash.com/photo-1511497584788-876760111969?q=80&w=1920">
        </div>
        <div id="hero-layer"></div>
    </div>

    <div id="side-panel">
        <div id="btn-toggle" onclick="$('side-panel').classList.toggle('hidden')">‚óÄ</div>
        <div class="scroll-area">
            <div id="ai-status">–°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê</div>

            <div class="group" id="ai-group">
                <div class="group-name">1. –ò–ò –°–∫–∞–Ω–µ—Ä –≥–µ—Ä–æ–µ–≤</div>
                <input type="password" id="api-key" placeholder="API Key Remove.bg" style="width:100%; padding:8px; margin-bottom:10px; background:#000; color:#fff; border:1px solid #444;">
                <div class="cam-preview"><video id="video-feed" autoplay playsinline></video></div>
                <button class="btn-green" onclick="snapCamera()">‚úÇÔ∏è –°–ö–ê–ù–ò–†–û–í–ê–¢–¨ –ì–ï–†–û–Ø</button>
                <button onclick="$('file-pc').click()">üìÇ –ó–ê–ì–†–£–ó–ò–¢–¨ –° –ü–ö</button>
                <input type="file" id="file-pc" hidden onchange="aiProcess(this.files[0])">
            </div>

            <div class="group">
                <div class="group-name">2. –û–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –ó–≤—É–∫</div>
                <button onclick="$('bg-file').click()">üñºÔ∏è –°–ú–ï–ù–ò–¢–¨ –§–û–ù</button>
                <input type="file" id="bg-file" hidden onchange="updateBg(this)">
                
                <label style="font-size:9px">–í–ï–¢–ï–† (–°–ö–û–†–û–°–¢–¨)</label>
                <input type="range" min="1" max="20" value="10" oninput="updateWind(this.value)">
                
                <label style="font-size:9px; display:block; margin-top:10px;">–ó–í–£–ö (MP3)</label>
                <button onclick="$('audio-file').click()">üéµ –í–´–ë–†–ê–¢–¨ –ó–í–£–ö</button>
                <input type="file" id="audio-file" hidden accept="audio/*" onchange="updateAudio(this)">
                <input type="range" id="vol-control" min="0" max="1" step="0.1" value="0.5" oninput="if(window.bgTrack) window.bgTrack.volume=this.value">
            </div>

            <div class="group" id="remote-group">
                <button style="background:#4a148c" onclick="showQR()">üì≤ –ü–û–î–ö–õ–Æ–ß–ò–¢–¨ –ü–£–õ–¨–¢</button>
            </div>

            <div id="hero-list"></div>
        </div>
    </div>
</div>

<script>
    const $ = id => document.getElementById(id);
    let heroes = [];
    let peer, conn, myMode;

    function initMode(mode) {
        myMode = mode;
        $('selector').style.display = 'none';
        
        if(mode === 'phone') {
            $('forest').style.display = 'none';
            $('side-panel').style.width = '100%';
            $('side-panel').classList.remove('hidden');
            $('btn-toggle').style.display = 'none';
            $('remote-group').style.display = 'none';
            setupPeer(null);
        } else {
            setupPeer('forest-master-v19');
            setupCamera();
        }
        requestAnimationFrame(loop);
    }

    async function setupCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            $('video-feed').srcObject = stream;
        } catch(e) { setStatus("–ö–ê–ú–ï–†–ê –û–®–ò–ë–ö–ê"); }
    }

    // --- –°–í–Ø–ó–¨ ---
    function setupPeer(id) {
        peer = new Peer(id);
        peer.on('open', (pid) => {
            if(myMode === 'phone') {
                const urlParams = new URLSearchParams(window.location.search);
                connectToMaster(urlParams.get('c') || 'forest-master-v19');
            }
        });
        peer.on('connection', c => {
            conn = c;
            setStatus("üì± –ü–£–õ–¨–¢ –ü–û–î–ö–õ–Æ–ß–ï–ù");
            conn.on('data', data => { if(data.type === 'hero') addHero(data.src); });
        });
    }

    function connectToMaster(target) {
        conn = peer.connect(target);
        conn.on('open', () => setStatus("‚úÖ –°–í–Ø–ó–¨ –£–°–¢–ê–ù–û–í–õ–ï–ù–ê"));
    }

    function showQR() {
        const url = window.location.href.split('?')[0] + '?c=forest-master-v19';
        const qr = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}`;
        $('qr-code').innerHTML = `<img src="${qr}">`;
        $('qr-box').style.display = ($('qr-box').style.display === 'block') ? 'none' : 'block';
    }

    // --- –ò–ò ---
    async function aiProcess(file) {
        const key = $('api-key').value;
        if(!key) { alert("–í–°–¢–ê–í–¨–¢–ï API KEY!"); return; }
        setStatus("üöÄ –ò–ò –û–ë–†–ê–ë–û–¢–ö–ê...");

        const fd = new FormData();
        fd.append('image_file', file);

        try {
            const res = await fetch('https://api.remove.bg/v1.0/removebg', {
                method: 'POST', headers: {'X-Api-Key': key}, body: fd
            });

            if(res.ok) {
                const blob = await res.blob();
                if(myMode === 'phone' && conn) {
                    const reader = new FileReader();
                    reader.onloadend = () => conn.send({type: 'hero', src: reader.result});
                    reader.readAsDataURL(blob);
                    setStatus("‚ú® –û–¢–ü–†–ê–í–õ–ï–ù–û –ù–ê –≠–ö–†–ê–ù");
                } else {
                    addHero(URL.createObjectURL(blob));
                    setStatus("‚ú® –ì–û–¢–û–í–û!");
                }
            } else { setStatus("‚ùå –û–®–ò–ë–ö–ê –°–ï–†–í–ï–†–ê"); }
        } catch(e) { setStatus("‚ùå –û–®–ò–ë–ö–ê –°–ï–¢–ò"); }
    }

    function snapCamera() {
        const canvas = document.createElement('canvas');
        const v = $('video-feed');
        canvas.width = v.videoWidth; canvas.height = v.videoHeight;
        canvas.getContext('2d').drawImage(v, 0, 0);
        canvas.toBlob(b => aiProcess(b));
    }

    // --- –õ–û–ì–ò–ö–ê –ì–ï–†–û–ï–í ---
    function addHero(src) {
        const id = Date.now();
        const img = document.createElement('img');
        img.src = src; img.className = 'hero';
        
        const line = heroes.length % 2;
        const forestH = $('forest').clientHeight;
        // –õ–∏–Ω–∏–∏: 50% –∏ 85% –æ—Ç –≤—ã—Å–æ—Ç—ã. –ù–æ–≥–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –Ω–∏–º.
        const groundY = line === 0 ? forestH * 0.45 : forestH * 0.85;
        const startSize = line === 0 ? 120 : 200;

        img.style.bottom = (forestH - groundY) + "px";
        img.style.zIndex = line === 0 ? 5 : 15;
        img.style.width = startSize + "px";
        $('hero-layer').appendChild(img);

        const hero = { id, el: img, x: -200, y: groundY, size: startSize, speed: 10, angle: 0 };
        heroes.push(hero);

        const card = document.createElement('div');
        card.className = 'hero-card'; card.id = 'ui-' + id;
        card.innerHTML = `
            <img src="${src}" class="mini-img">
            <div style="flex:1">
                <input type="range" min="30" max="600" value="${startSize}" oninput="modHero(${id},'size',this.value)">
                <input type="range" min="0" max="50" value="10" oninput="modHero(${id},'speed',this.value)">
            </div>
            <button onclick="delHero(${id})" style="width:30px; background:#6b2121">√ó</button>
        `;
        $('hero-list').appendChild(card);
    }

    window.modHero = (id, type, val) => {
        const h = heroes.find(x => x.id === id);
        if(!h) return;
        if(type === 'size') { h.size = val; h.el.style.width = val + "px"; }
        if(type === 'speed') h.speed = val;
    };

    window.delHero = id => {
        const i = heroes.findIndex(x => x.id === id);
        if(i > -1) { heroes[i].el.remove(); heroes.splice(i, 1); $('ui-'+id).remove(); }
    };

    // --- –§–û–ù –ò –ó–í–£–ö ---
    function updateBg(i) { if(i.files[0]) $('bg-media').src = URL.createObjectURL(i.files[0]); }
    function updateWind(v) {
        $('bg-wrap').style.setProperty('--ws', (21 - v) / 2 + 's');
        $('bg-wrap').style.setProperty('--wp', (v / 2) + 'deg');
    }
    function updateAudio(i) {
        if(window.bgTrack) window.bgTrack.pause();
        window.bgTrack = new Audio(URL.createObjectURL(i.files[0]));
        window.bgTrack.loop = true;
        window.bgTrack.volume = $('vol-control').value;
        window.bgTrack.play();
    }
    function setStatus(txt) { $('ai-status').innerText = txt; }

    // --- –¶–ò–ö–õ ---
    function loop() {
        const w = $('forest').clientWidth;
        heroes.forEach(h => {
            h.x += (h.speed / 10);
            if(h.x > w + 200) h.x = -h.size;
            h.angle += 0.04;
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏—è –ø—Ä–∏ —Ö–æ–¥—å–±–µ
            h.el.style.transform = `translateX(${h.x}px) translateY(${Math.sin(h.angle)*4}px)`;
        });
        requestAnimationFrame(loop);
    }
</script>
</body>
</html>
