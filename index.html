<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–ê–ó–ê 10.0 - –°–ò–ù–•–†–û</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --accent: #ff9d00; --bg: #0e120a; --panel: #1a1d16; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; color: #e0e0e0; }
        
        /* –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ */
        #mode-selector { position: fixed; inset: 0; z-index: 9999; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
        .mode-btn { padding: 20px 40px; font-size: 20px; font-weight: bold; border-radius: 15px; border: none; cursor: pointer; transition: 0.3s; width: 280px; }
        #btn-screen { background: #3d4435; color: white; }
        #btn-remote { background: var(--accent); color: black; }

        #main-container { display: flex; width: 100vw; height: 100vh; }
        #forest { flex: 1; position: relative; overflow: hidden; }
        
        #bg-media-container { position: absolute; width: 100%; height: 100%; z-index: 1; display: flex; align-items: center; justify-content: center; transform-origin: bottom center; }
        #bg-img, #bg-video { width: 100%; height: 100%; object-fit: contain; transition: transform 0.1s; }

        @keyframes wind-sway { 0%, 100% { transform: skewX(0deg); } 50% { transform: skewX(var(--wind-power, 2deg)); } }
        .sway-active { animation: wind-sway 6s ease-in-out infinite; }
        #hero-layer { position: absolute; inset: 0; z-index: 2; pointer-events: none; }

        /* –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        #scanner { width: 350px; background: var(--panel); display: flex; flex-direction: column; padding: 15px; z-index: 10; overflow-y: auto; border-left: 2px solid #2d3326; }
        .hidden { display: none !important; }

        .camera-box { position: relative; width: 100%; max-width: 180px; aspect-ratio: 1/1; border-radius: 12px; overflow: hidden; border: 2px solid #444; margin: 0 auto 10px; background: #111; }
        video#camera-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        .group { background: #22261d; padding: 12px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #333; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-top: 5px; background: #3d4435; color: white; }
        input[type="range"] { width: 100%; accent-color: var(--accent); margin-top: 5px; }
        .hero { position: absolute; will-change: transform; transition: opacity 0.5s; }
        .journal-item { background: #151812; padding: 10px; border-radius: 8px; margin-top: 8px; border: 1px solid #444; font-size: 12px; }
    </style>
</head>
<body>

<div id="mode-selector">
    <h2 style="margin-bottom: 10px;">–ë–ê–ó–ê 10.0: –ö–¢–û –Ø?</h2>
    <button id="btn-screen" class="mode-btn">üíª –†–ï–ñ–ò–ú –≠–ö–†–ê–ù–ê</button>
    <button id="btn-remote" class="mode-btn">üì± –†–ï–ñ–ò–ú –ü–£–õ–¨–¢–ê</button>
</div>

<div id="main-container">
    <div id="forest">
        <div id="bg-media-container" class="sway-active" style="--wind-power: 2deg;">
            <img id="bg-img" src="https://images.unsplash.com/photo-1511497584788-876760111969?auto=format&fit=crop&w=1500&q=80">
            <video id="bg-video" loop muted playsinline></video>
        </div>
        <audio id="bg-audio" loop></audio>
        <div id="hero-layer"></div>
    </div>

    <div id="scanner" class="hidden">
        <div class="camera-box"><video id="camera-feed" autoplay playsinline></video></div>
        <div class="group">
            <button onclick="$('hero-in').click()">üìÇ –ó–ê–ì–†–£–ó–ò–¢–¨ –ì–ï–†–û–Ø</button>
            <input type="file" id="hero-in" hidden accept="image/*">
            <input type="password" id="api-key" placeholder="API Key" style="width:100%; padding:8px; margin-top:10px; background:#111; color:#fff; border:1px solid #444;">
            <button id="scan-btn" style="background:var(--accent); color:black;">‚ú® –û–ñ–ò–í–ò–¢–¨ –†–ò–°–£–ù–û–ö</button>
        </div>
        <div id="hero-journal"></div>
    </div>
</div>

<canvas id="proc-canvas" style="display:none"></canvas>

<script>
    const $ = id => document.getElementById(id);
    
    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyAOdgn7U8MKRbroByVJJXyL2NgQS405M64",
        authDomain: "lesbaza-d8fc9.firebaseapp.com",
        projectId: "lesbaza-d8fc9",
        storageBucket: "lesbaza-d8fc9.firebasestorage.app",
        messagingSenderId: "957259867268",
        appId: "1:957259867268:web:b1dda420365ee6a2460ed1",
        databaseURL: "https://lesbaza-d8fc9-default-rtdb.europe-west1.firebasedatabase.app/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref('forest_session');

    const state = { heroes: [], isRemote: false };

    // --- –í–´–ë–û–† –†–ï–ñ–ò–ú–ê ---
    $('btn-screen').onclick = () => { $('mode-selector').remove(); startApp(false); };
    $('btn-remote').onclick = () => { $('mode-selector').remove(); $('scanner').classList.remove('hidden'); startApp(true); };

    function startApp(remote) {
        state.isRemote = remote;
        if(remote) initCamera();
        
        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ
        db.on('value', snapshot => {
            const data = snapshot.val();
            if(!data) return;
            if(data.heroes) syncHeroes(data.heroes);
        });

        requestAnimationFrame(animate);
    }

    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            $('camera-feed').srcObject = stream;
        } catch (e) { console.log("–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"); }
    }

    // --- –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ì–ï–†–û–ï–í ---
    function syncHeroes(cloudHeroes) {
        // –£–¥–∞–ª—è–µ–º —Ç–µ—Ö, –∫–æ–≥–æ –Ω–µ—Ç –≤ –æ–±–ª–∞–∫–µ
        state.heroes.forEach(h => {
            if(!cloudHeroes[h.id]) { h.el.remove(); h.deleted = true; }
        });
        state.heroes = state.heroes.filter(h => !h.deleted);

        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã—Ö –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º
        Object.keys(cloudHeroes).forEach(id => {
            const data = cloudHeroes[id];
            let h = state.heroes.find(x => x.id == id);
            
            if(!h) {
                const img = document.createElement('img');
                img.src = data.src; img.className = 'hero';
                $('hero-layer').appendChild(img);
                h = { id, el: img, angle: Math.random()*5 };
                state.heroes.push(h);
                if(state.isRemote) addJournalItem(id);
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –æ–±–ª–∞–∫–∞
            h.x = data.x; h.y = data.y; h.size = data.size; h.speed = data.speed; h.dx = data.dx;
            h.el.style.width = h.size + 'px';
        });
    }

    // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï (–î–õ–Ø –ü–£–õ–¨–¢–ê) ---
    $('scan-btn').onclick = async () => {
        const key = $('api-key').value;
        if(!key) return alert("–ù—É–∂–µ–Ω API Key!");
        const canv = $('proc-canvas'); const ctx = canv.getContext('2d'); const v = $('camera-feed');
        canv.width = 500; canv.height = 500;
        ctx.drawImage(v, 0, 0, 500, 500);
        canv.toBlob(async blob => {
            const fd = new FormData(); fd.append('image_file', blob);
            const res = await fetch('https://api.remove.bg/v1.0/removebg', { method: 'POST', headers: { 'X-Api-Key': key }, body: fd });
            if(res.ok) {
                const reader = new FileReader();
                reader.readAsDataURL(await res.blob());
                reader.onloadend = () => uploadHero(reader.result);
            }
        });
    };

    $('hero-in').onchange = e => {
        const reader = new FileReader();
        reader.onload = () => uploadHero(reader.result);
        reader.readAsDataURL(e.target.files[0]);
    };

    function uploadHero(base64) {
        const id = Date.now();
        db.child('heroes').child(id).set({
            src: base64, x: 100, y: 300, size: 120, speed: 10, dx: 1
        });
    }

    function addJournalItem(id) {
        if($('item-'+id)) return;
        const div = document.createElement('div');
        div.className = 'journal-item'; div.id = 'item-'+id;
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between"><span>–ì–µ—Ä–æ–π ${id.toString().slice(-4)}</span><button onclick="deleteHero(${id})" style="width:30px; margin:0">‚úñ</button></div>
            –†–∞–∑–º–µ—Ä: <input type="range" min="40" max="400" value="120" onchange="updateCloud(${id}, 'size', this.value)">
            –°–∫–æ—Ä–æ—Å—Ç—å: <input type="range" min="0" max="50" value="10" onchange="updateCloud(${id}, 'speed', this.value)">`;
        $('hero-journal').appendChild(div);
    }

    window.updateCloud = (id, field, val) => db.child('heroes').child(id).update({ [field]: parseInt(val) });
    window.deleteHero = id => { db.child('heroes').child(id).remove(); $('item-'+id).remove(); };

    // --- –ê–ù–ò–ú–ê–¶–ò–Ø (–î–õ–Ø –≠–ö–†–ê–ù–ê) ---
    function animate() {
        const viewW = $('forest').clientWidth;
        if(!state.isRemote && state.heroes.length > 0) {
            state.heroes.forEach(h => {
                h.x += (h.speed / 10) * h.dx;
                if(h.x > viewW) h.x = -h.size;
                if(h.x < -h.size) h.x = viewW;
                h.el.style.transform = `translate(${h.x}px, ${h.y}px) scaleX(${h.dx > 0 ? -1 : 1})`;
            });
        }
        requestAnimationFrame(animate);
    }
</script>
</body>
</html>
