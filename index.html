<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–ê–ó–ê 10.8 - FULL CONTROL</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --accent: #ff9d00; --bg: #0e120a; --panel: #1a1d16; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; color: #e0e0e0; }
        
        #mode-selector { position: fixed; inset: 0; z-index: 10000; background: #0e120a; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
        .mode-btn { padding: 20px; font-size: 20px; font-weight: bold; border-radius: 12px; border: none; cursor: pointer; width: 280px; }

        #main-container { display: flex; width: 100vw; height: 100vh; }
        #forest { flex: 1; position: relative; overflow: hidden; background: #000; }
        #bg-media-container { position: absolute; width: 100%; height: 100%; z-index: 1; display: flex; align-items: center; justify-content: center; transform-origin: bottom center; }
        #bg-img { width: 100%; height: 100%; object-fit: contain; transition: transform 0.3s; }
        #hero-layer { position: absolute; inset: 0; z-index: 2; }

        #scanner { width: 100%; max-width: 350px; background: var(--panel); display: flex; flex-direction: column; padding: 15px; z-index: 10; overflow-y: auto; border-left: 2px solid #2d3326; }
        .hidden { display: none !important; }
        .group { background: #22261d; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; }
        h4 { font-size: 12px; color: var(--accent); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        
        button { width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; background: #3d4435; color: white; margin-top: 8px; transition: 0.2s; }
        button:active { transform: scale(0.95); background: var(--accent); color: black; }
        
        label { font-size: 11px; display: block; margin: 10px 0 5px; opacity: 0.8; }
        input[type="range"] { width: 100%; accent-color: var(--accent); cursor: pointer; }
        
        .hero { position: absolute; will-change: transform; pointer-events: none; transition: width 0.3s; }
        #db-status { font-size: 10px; text-align: center; padding: 4px; border-radius: 4px; background: #000; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="mode-selector">
    <h2 style="color:var(--accent)">–ë–ê–ó–ê 10.8</h2>
    <button onclick="selectMode('screen')" class="mode-btn" style="background:#3d4435; color:white;">üíª –≠–ö–†–ê–ù (–ü–†–û–ï–ö–¢–û–†)</button>
    <button onclick="selectMode('remote')" class="mode-btn" style="background:var(--accent); color:black;">üì± –ü–£–õ–¨–¢ (–¢–ï–õ–ï–§–û–ù)</button>
</div>

<div id="main-container">
    <div id="forest">
        <div id="bg-media-container"><img id="bg-img" src="https://images.unsplash.com/photo-1511497584788-876760111969?auto=format&fit=crop&w=1500&q=80"></div>
        <div id="hero-layer"></div>
        <audio id="forest-audio" loop></audio>
    </div>

    <div id="scanner" class="hidden">
        <div id="db-status">–°–í–Ø–ó–¨: –û–ñ–ò–î–ê–ù–ò–ï...</div>

        <div class="group">
            <h4>üå≤ –õ–µ—Å</h4>
            <label>–ú–∞—Å—à—Ç–∞–±:</label>
            <input type="range" id="zoom-range" min="50" max="300" value="100">
            <button onclick="$('bg-in').click()">üñºÔ∏è –°–º–µ–Ω–∏—Ç—å —Ñ–æ–Ω</button>
            <input type="file" id="bg-in" hidden accept="image/*">
        </div>

        <div class="group">
            <h4>üîä –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞</h4>
            <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å:</label>
            <input type="range" id="vol-range" min="0" max="100" value="50">
            <button onclick="$('audio-in').click()">üéµ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–≤—É–∫</button>
            <input type="file" id="audio-in" hidden accept="audio/*">
        </div>

        <div class="group">
            <h4>üëæ –ì–µ—Ä–æ–∏ (–ù–µ–π—Ä–æ–Ω–∫–∞)</h4>
            <button onclick="$('hero-in').click()" style="background: var(--accent); color: black;">‚ú® –î–æ–±–∞–≤–∏—Ç—å –≥–µ—Ä–æ—è</button>
            <input type="file" id="hero-in" hidden accept="image/*">
            <button onclick="clearHeroes()" style="background: #5e2626; font-size: 10px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö</button>
        </div>
    </div>
</div>

<script>
    const $ = id => document.getElementById(id);

    const firebaseConfig = {
        apiKey: "AIzaSyAOdgn7U8MKRbroByVJJXyL2NgQS405M64",
        authDomain: "lesbaza-d8fc9.firebaseapp.com",
        projectId: "lesbaza-d8fc9",
        databaseURL: "https://lesbaza-d8fc9-default-rtdb.firebaseio.com/"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const dbRef = database.ref('forest_session');

    let isRemote = false;
    let heroes = [];

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏
    database.ref('.info/connected').on('value', snap => {
        const s = $('db-status');
        if (snap.val() === true) { s.innerText = "–°–í–Ø–ó–¨: –û–ö ‚úÖ"; s.style.color = "#00ff00"; }
        else { s.innerText = "–°–í–Ø–ó–¨: –û–®–ò–ë–ö–ê ‚ùå"; s.style.color = "#ff0000"; }
    });

    function selectMode(mode) {
        $('mode-selector').style.display = 'none';
        isRemote = (mode === 'remote');
        if (isRemote) {
            $('scanner').classList.remove('hidden');
            $('forest').classList.add('hidden');
            setupRemoteControls();
        } else {
            // –ù–∞ —ç–∫—Ä–∞–Ω–µ —Å—Ä–∞–∑—É –∑–∞–ø—É—Å–∫–∞–µ–º –∑–≤—É–∫ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ (–ø–æ–ª–∏—Ç–∏–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤)
            document.body.onclick = () => $('forest-audio').play();
        }
        setupSync();
        requestAnimationFrame(animate);
    }

    // –¢–ï–õ–ï–§–û–ù: –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥
    function setupRemoteControls() {
        $('zoom-range').oninput = e => dbRef.child('world').update({ zoom: e.target.value });
        $('vol-range').oninput = e => dbRef.child('world').update({ volume: e.target.value / 100 });
        
        $('bg-in').onchange = e => uploadFile(e.target.files[0], 'bg');
        $('audio-in').onchange = e => uploadFile(e.target.files[0], 'audio');
        $('hero-in').onchange = e => uploadFile(e.target.files[0], 'hero');
    }

    function uploadFile(file, type) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
            if (type === 'bg') dbRef.child('world').update({ bg: reader.result });
            if (type === 'audio') dbRef.child('world').update({ audio: reader.result });
            if (type === 'hero') {
                const id = 'h_' + Date.now();
                dbRef.child('heroes').child(id).set({
                    src: reader.result,
                    x: Math.random() * 500,
                    y: Math.random() * 400 + 100,
                    size: Math.random() * 150 + 50,
                    speed: Math.random() * 20 + 5,
                    dx: Math.random() > 0.5 ? 1 : -1
                });
            }
        };
        reader.readAsDataURL(file);
    }

    function clearHeroes() { dbRef.child('heroes').remove(); }

    // –ü–†–û–ï–ö–¢–û–†: –ü—Ä–∏–µ–º –∫–æ–º–∞–Ω–¥
    function setupSync() {
        dbRef.on('value', snap => {
            const data = snap.val() || {};
            
            if (!isRemote) {
                // –°–∏–Ω—Ö—Ä–æ –º–∏—Ä–∞ –∏ –∑–≤—É–∫–∞
                if (data.world) {
                    if (data.world.zoom) $('bg-img').style.transform = `scale(${data.world.zoom/100})`;
                    if (data.world.bg) $('bg-img').src = data.world.bg;
                    if (data.world.audio && $('forest-audio').src !== data.world.audio) {
                        $('forest-audio').src = data.world.audio;
                        $('forest-audio').play();
                    }
                    if (data.world.volume !== undefined) $('forest-audio').volume = data.world.volume;
                }

                // –°–∏–Ω—Ö—Ä–æ –≥–µ—Ä–æ–µ–≤
                const cloudHeroes = data.heroes || {};
                heroes.forEach(h => { if (!cloudHeroes[h.id]) { h.el.remove(); h.deleted = true; } });
                heroes = heroes.filter(h => !h.deleted);

                Object.keys(cloudHeroes).forEach(id => {
                    let h = heroes.find(x => x.id === id);
                    if (!h) {
                        const img = document.createElement('img');
                        img.src = cloudHeroes[id].src;
                        img.className = 'hero';
                        $('hero-layer').appendChild(img);
                        h = { id, el: img };
                        heroes.push(h);
                    }
                    const d = cloudHeroes[id];
                    h.x = d.x; h.y = d.y; h.size = d.size; h.speed = d.speed; h.dx = d.dx;
                    h.el.style.width = h.size + 'px';
                });
            }
        });
    }

    function animate() {
        if (!isRemote) {
            const vw = $('forest').clientWidth;
            heroes.forEach(h => {
                h.x += (h.speed / 10) * h.dx;
                if (h.x > vw + 100) h.x = -h.size;
                if (h.x < -h.size - 100) h.x = vw;
                h.el.style.transform = `translate(${h.x}px, ${h.y}px) scaleX(${h.dx > 0 ? -1 : 1})`;
            });
        }
        requestAnimationFrame(animate);
    }
</script>
</body>
</html>
